# ════════════════════════════════════════════════════════════
# OmniKross Landing — Docker Compose
# Single lightweight container: Bun API + SQLite
# ════════════════════════════════════════════════════════════

services:
  omnikross-api:
    build:
      context: .
      dockerfile: Dockerfile

    container_name: omnikross-landing

    restart: unless-stopped

    # Bind only to localhost (nginx will proxy)
    ports:
      - '127.0.0.1:3000:3000'

    volumes:
      # Persistent SQLite database
      - ./data:/app/data
      # Static files (read-only)
      - ./public:/app/public:ro

    environment:
      - NODE_ENV=production
      - TZ=Europe/Moscow
      - MAX_SIGNUPS=500
      - PORT=3000

    # Resource limits (Docker Compose v1 compatibility)
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M

    healthcheck:
      test: ['CMD', 'bun', '-e', 'fetch("http://localhost:3000/api/health").then(() => process.exit(0)).catch(() => process.exit(1))']
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    # Logging configuration
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'
        compress: 'true'

# Optional: Network isolation
networks:
  default:
    driver: bridge
